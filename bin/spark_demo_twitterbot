#!/usr/bin/env ruby
$stdout.sync = true
$LOAD_PATH.unshift File.join(File.dirname(__FILE__), '..', 'lib')
require 'spark_demo_twitterbot'

if ARGV.empty?
  puts 'A twitter track term is required.'
  puts 'Try something like:'
  puts "  ./bin/spark_demo_twitterbot '#hellospark'"
  exit 1
else
  track_term = ARGV[0]
end

EM.run do
  spark_device = SparkDemoTwitterbot::SparkDevice.new ENV['SPARK_DEVICE_ID']
  twitter_search = SparkDemoTwitterbot::TwitterSearch.new(track_term)
  EM.add_periodic_timer(5) do
    twitter_search.get do |results|
      unless results['statuses'].empty?
        results['statuses'].each_with_index do |tweet, index|
          EM.add_timer(index) do
            twitter_search.last_id = tweet['id']
            if tweet['retweeted_status']
              puts '--RT--> ' + tweet['text']
              followers_count = tweet['user']['followers_count'] +
                                tweet['retweeted_status']['user']['followers_count']
              spark_device.handle_retweet followers_count
            else
              puts tweet['text']
              spark_device.handle_tweet tweet['user']['followers_count']
            end
          end
        end
      end
    end
  end
end
