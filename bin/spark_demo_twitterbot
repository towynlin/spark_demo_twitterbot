#!/usr/bin/env ruby
$stdout.sync = true
$LOAD_PATH.unshift File.join(File.dirname(__FILE__), '..', 'lib')
require 'spark_demo_twitterbot'

if ARGV.empty?
  puts 'A twitter track term is required.'
  puts 'Try something like:'
  puts "  ./bin/spark_demo_twitterbot '#hellospark'"
  exit 1
else
  track_term = ARGV[0]
end

EM.run do
  # bind to a port to satisfy heroku
  EM.start_server '0.0.0.0', ENV['PORT'], SparkDemoTwitterbot::DummyServer

  spark_device = SparkDemoTwitterbot::SparkDevice.new ENV['SPARK_DEVICE_ID']

  SparkDemoTwitterbot::TwitterStream.new(track_term) do |tweet|
    puts tweet['text']
    if tweet['retweeted_status']
      followers_count = tweet['user']['followers_count'] +
                        tweet['retweeted_status']['user']['followers_count']
      spark_device.handle_retweet followers_count
    else
      spark_device.handle_tweet tweet['user']['followers_count']
    end
  end
end
